<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ƒêƒÉng nh·∫≠p - Security App</title>
  <link rel="stylesheet" href="/css/modern-style.css">
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <style>
    .auth-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 2rem 0;
    }

    .auth-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 2.5rem;
      width: 100%;
      max-width: 450px;
      animation: fadeIn 0.5s ease-in-out;
    }

    .auth-card h2 {
      text-align: center;
      margin-bottom: 0.5rem;
      color: var(--text-dark);
    }

    .auth-card .subtitle {
      text-align: center;
      color: var(--text-gray);
      margin-bottom: 2rem;
      font-size: 0.95rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-dark);
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      font-size: 1rem;
    }

    .form-actions {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .form-footer {
      text-align: center;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border-gray);
    }

    .form-footer p {
      margin: 0.5rem 0;
    }

    .form-footer a {
      color: var(--primary-blue);
      text-decoration: none;
      font-weight: 600;
    }

    .form-footer a:hover {
      color: #2563eb;
    }

    .error-message {
      background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);
      color: #7f1d1d;
      padding: 1.2rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      border-left: 4px solid #dc2626;
      font-weight: 500;
      line-height: 1.6;
    }

    .error-message strong {
      color: #991b1b;
      font-weight: 700;
    }

    .warning-message {
      background: linear-gradient(135deg, #fff3cd 0%, #fffbea 100%);
      color: #92400e;
      padding: 1.2rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      border-left: 4px solid #f59e0b;
      font-weight: 500;
      line-height: 1.6;
      animation: shake 0.5s ease-in-out;
    }

    .warning-message strong {
      color: #d97706;
      font-weight: 700;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .captcha-container {
      margin: 1.5rem 0;
      padding: 1rem;
      background: #f0f4ff;
      border-radius: 0.5rem;
      border-left: 4px solid #3b82f6;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .captcha-container p {
      color: #1e40af;
      font-weight: 600;
      margin-bottom: 1rem;
      text-align: center;
    }

    .g-recaptcha {
      margin: 0 auto;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
    }

    .locked-account-timer {
      animation: pulse 1s ease-in-out infinite;
    }

    .locked-account-section {
      animation: fadeIn 0.5s ease-in-out;
    }
  </style>
</head>
<body>
  <div class="auth-page">
    <div class="auth-card">
      <h2>üîê ƒêƒÉng nh·∫≠p</h2>
      <p class="subtitle">Truy c·∫≠p t√†i kho·∫£n c·ªßa b·∫°n</p>
      
      <% if (error) { %>
        <div class="error-message">
          <%= error %>
        </div>
      <% } %>

      <!-- Locked Account Display -->
      <% if (failedAttempts && failedAttempts >= 10) { %>
        <div style="background: #fee2e2; border: 2px solid #dc2626; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üîí</div>
          <h3 style="color: #991b1b; margin: 0 0 1rem 0; font-size: 1.5rem;">T√†i kho·∫£n b·ªã kh√≥a</h3>
          
          <p style="color: #7f1d1d; margin: 0.5rem 0; font-weight: 500;">
            B·∫°n ƒë√£ nh·∫≠p sai m·∫≠t kh·∫©u <strong>10 l·∫ßn</strong>
          </p>
          
          <div style="background: white; border: 2px dashed #dc2626; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0;">
            <p style="color: #7f1d1d; margin: 0.5rem 0; font-size: 0.9rem;">T√†i kho·∫£n s·∫Ω m·ªü kh√≥a sau:</p>
            <div style="font-size: 2rem; font-weight: bold; color: #dc2626; margin: 0.5rem 0;">
              <span id="countdownTimer">10:00</span>
            </div>
            <p style="color: #7f1d1d; margin: 0.5rem 0; font-size: 0.85rem;">ph√∫t: gi√¢y</p>
          </div>
          
          <div style="background: #fef2f2; border-left: 4px solid #dc2626; padding: 1rem; border-radius: 0.25rem; margin: 1rem 0; text-align: left;">
            <p style="color: #7f1d1d; margin: 0; font-size: 0.9rem; line-height: 1.5;">
              <strong>üîê L√Ω do kh√≥a:</strong> B·∫£o v·ªá t√†i kho·∫£n c·ªßa b·∫°n kh·ªèi truy c·∫≠p tr√°i ph√©p<br>
              <strong>‚è±Ô∏è Th·ªùi gian:</strong> 10 ph√∫t k·ªÉ t·ª´ l·∫ßn ƒëƒÉng nh·∫≠p sai th·ª© 10<br>
              <strong>üí° G·ª£i √Ω:</strong> H√£y ch·∫Øc ch·∫Øn r·∫±ng b·∫°n nh·ªõ m·∫≠t kh·∫©u ƒë√∫ng
            </p>
          </div>

          <a href="/forgot-password" style="display: inline-block; background: #3b82f6; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; text-decoration: none; font-weight: 500; margin-top: 1rem;">
            ‚ùì Qu√™n m·∫≠t kh·∫©u?
          </a>
        </div>

        <!-- Hidden locked form - kh√¥ng cho ph√©p submit -->
        <form style="opacity: 0.5; pointer-events: none;">
          <div class="form-group">
            <label for="username">üë§ T√™n ƒëƒÉng nh·∫≠p</label>
            <input type="text" id="username" name="username" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" disabled>
          </div>
          <div class="form-group">
            <label for="password">üîë M·∫≠t kh·∫©u</label>
            <input type="password" id="password" name="password" placeholder="M·∫≠t kh·∫©u" disabled>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-primary btn-lg" disabled style="cursor: not-allowed;">
              ƒêƒÉng nh·∫≠p (T√†i kho·∫£n b·ªã kh√≥a)
            </button>
          </div>
        </form>

        <script>
          // Countdown timer for locked account
          function startCountdown() {
            const lockDuration = 10 * 60; // 10 ph√∫t t√≠nh b·∫±ng gi√¢y
            let timeLeft = lockDuration;
            
            const updateTimer = () => {
              const minutes = Math.floor(timeLeft / 60);
              const seconds = timeLeft % 60;
              const display = 
                String(minutes).padStart(2, '0') + ':' + 
                String(seconds).padStart(2, '0');
              
              const timerElement = document.getElementById('countdownTimer');
              if (timerElement) {
                timerElement.innerText = display;
              }
              
              if (timeLeft <= 0) {
                // T√†i kho·∫£n ƒë√£ m·ªü kh√≥a
                const lockedSection = document.querySelector('[style*="fee2e2"]');
                if (lockedSection) {
                  lockedSection.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                      <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                      <h3 style="color: #059669; margin: 0 0 1rem 0;">T√†i kho·∫£n ƒë√£ m·ªü kh√≥a</h3>
                      <p style="color: #047857;">B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p l·∫°i b√¢y gi·ªù</p>
                      <button onclick="location.reload()" style="background: #10b981; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500; margin-top: 1rem;">
                        ‚Üª T·∫£i l·∫°i trang
                      </button>
                    </div>
                  `;
                }
              }
              
              timeLeft--;
              if (timeLeft > 0) {
                setTimeout(updateTimer, 1000);
              }
            };
            
            updateTimer();
          }
          
          window.addEventListener('load', startCountdown);
        </script>
      <% } else if (failedAttempts && failedAttempts > 0) { %>
        <!-- Warning for attempts < 10 -->
        <div class="warning-message">
          <% if (failedAttempts >= 5) { %>
            ‚ö†Ô∏è <strong>C·∫£nh b√°o - CAPTCHA y√™u c·∫ßu!</strong><br>
            B·∫°n ƒë√£ nh·∫≠p sai <strong><%= failedAttempts %> l·∫ßn</strong><br>
            C√≤n <strong><%= 10 - failedAttempts %> l·∫ßn</strong> ƒë·ªÉ th·ª≠ tr∆∞·ªõc khi t√†i kho·∫£n b·ªã kh√≥a 10 ph√∫t
          <% } else { %>
            ‚ö†Ô∏è <strong>C·∫£nh b√°o:</strong> B·∫°n ƒë√£ nh·∫≠p sai <strong><%= failedAttempts %> l·∫ßn</strong><br>
            C√≤n <strong><%= 10 - failedAttempts %> l·∫ßn</strong> ƒë·ªÉ th·ª≠<br>
            T·ªëi ƒëa 10 l·∫ßn nh·∫≠p sai, sau ƒë√≥ t√†i kho·∫£n s·∫Ω b·ªã kh√≥a 10 ph√∫t
          <% } %>
        </div>
      <% } %>

      <!-- Login Form -->
      <% if (!require2FA) { %>
        <form action="/login" method="POST" id="loginForm">
          <input type="hidden" name="redirect" value="<%= redirect || '/profile' %>">
          <input type="hidden" name="_csrf" value="<%= csrfToken || '' %>">
          
          <div class="form-group">
            <label for="username">üë§ T√™n ƒëƒÉng nh·∫≠p</label>
            <input type="text" id="username" name="username" required 
                   placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p c·ªßa b·∫°n"
                   value="<%= username || '' %>"
                   autofocus>
          </div>

          <div class="form-group">
            <label for="password">üîë M·∫≠t kh·∫©u</label>
            <input type="password" id="password" name="password" required 
                   placeholder="M·∫≠t kh·∫©u">
          </div>

          <% if (requireCaptcha) { %>
            <div style="margin: 1.5rem 0; padding: 1rem; background: #f0f4ff; border-radius: 0.5rem; border-left: 4px solid #3b82f6;">
              <p style="color: #1e40af; font-weight: 600; margin-bottom: 1rem;">ü§ñ X√°c th·ª±c:</p>
              
              <!-- ReCAPTCHA -->
              <div id="recaptchaContainer">
                <div class="g-recaptcha" data-sitekey="6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI"></div>
              </div>
              
              <!-- Fallback: Simple CAPTCHA n·∫øu ReCAPTCHA kh√¥ng load -->
              <div id="fallbackCaptcha" style="display:none; text-align: center;">
                <p style="color: #1e40af; font-weight: 500; margin-bottom: 1rem;">
                  Nh·∫≠p 2 ch·ªØ s·ªë sau ƒë·ªÉ x√°c th·ª±c:
                </p>
                <div style="background: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 2rem; font-weight: bold; letter-spacing: 0.5rem; color: #3b82f6;" id="captchaCode"></div>
                <input type="text" id="captchaInput" placeholder="Nh·∫≠p m√£ x√°c th·ª±c" maxlength="2" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 0.5rem; text-align: center; font-size: 1.2rem;" />
              </div>
            </div>
          <% } %>

          <input type="hidden" name="g-recaptcha-response" id="g-recaptcha-response">

          <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg">ƒêƒÉng nh·∫≠p</button>
          </div>

          <div class="form-footer">
            <p><a href="/forgot-password">‚ùì Qu√™n m·∫≠t kh·∫©u?</a></p>
            <p>Ch∆∞a c√≥ t√†i kho·∫£n? <a href="/register">üìù ƒêƒÉng k√Ω ngay</a></p>
          </div>
        </form>
      <% } else { %>
        <!-- 2FA Form -->
        <form action="/login" method="POST" id="2faForm">
          <input type="hidden" name="redirect" value="<%= redirect || '/profile' %>">
          <input type="hidden" name="_csrf" value="<%= csrfToken || '' %>">
          <input type="hidden" name="userId" value="<%= userId || '' %>">
          <input type="hidden" name="email" value="<%= email || '' %>">
          
          <div class="form-group">
            <label for="twoFactorToken">üîê M√£ x√°c th·ª±c 2FA</label>
            <input type="text" id="twoFactorToken" name="twoFactorToken" required 
                   placeholder="Nh·∫≠p m√£ 6 ch·ªØ s·ªë"
                   maxlength="6"
                   pattern="[0-9]{6}"
                   autofocus>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg">X√°c th·ª±c</button>
          </div>

          <div class="form-footer">
            <p><a href="/login">‚Üê Quay l·∫°i ƒëƒÉng nh·∫≠p</a></p>
          </div>
        </form>
      <% } %>
    </div>
  </div>

  <script>
    // Hi·ªÉn th·ªã popup alert khi t·∫£i trang n·∫øu c√≥ failed attempts
    // eslint-disable-next-line no-undef
    const failedAttempts = <%-JSON.stringify(failedAttempts || 0)%>;
    
    window.addEventListener('load', function() {
      if (failedAttempts && failedAttempts > 0) {
        if (failedAttempts >= 10) {
          alert('üîí T√ÄI KHO·∫¢N B·ªä KH√ìA!\n\n' +
                'B·∫°n ƒë√£ nh·∫≠p sai m·∫≠t kh·∫©u 10 l·∫ßn.\n' +
                'T√†i kho·∫£n s·∫Ω m·ªü kh√≥a sau 10 ph√∫t.\n\n' +
                'Vui l√≤ng th·ª≠ l·∫°i sau.');
        } else if (failedAttempts >= 5) {
          alert('‚ö†Ô∏è C·∫¢NH B√ÅO!\n\n' +
                'B·∫°n ƒë√£ nh·∫≠p sai m·∫≠t kh·∫©u ' + failedAttempts + ' l·∫ßn.\n' +
                'C√≤n ' + (10 - failedAttempts) + ' l·∫ßn ƒë·ªÉ th·ª≠.\n\n' +
                'N·∫øu nh·∫≠p sai 10 l·∫ßn, t√†i kho·∫£n s·∫Ω b·ªã kh√≥a 10 ph√∫t!\n' +
                'Vui l√≤ng ho√†n th√†nh CAPTCHA ƒë·ªÉ ti·∫øp t·ª•c.');
        } else {
          alert('‚ö†Ô∏è C·∫¢NH B√ÅO!\n\n' +
                'B·∫°n ƒë√£ nh·∫≠p sai m·∫≠t kh·∫©u ' + failedAttempts + ' l·∫ßn.\n' +
                'C√≤n ' + (10 - failedAttempts) + ' l·∫ßn ƒë·ªÉ th·ª≠.\n\n' +
                'T·ªëi ƒëa 10 l·∫ßn nh·∫≠p sai, sau ƒë√≥ t√†i kho·∫£n s·∫Ω b·ªã kh√≥a 10 ph√∫t!');
        }
      }
    });

    const form = document.getElementById('loginForm');
    if (form) {
      // Kh·ªüi t·∫°o fallback CAPTCHA n·∫øu ReCAPTCHA kh√¥ng load
      initializeFallbackCaptcha();
      
      form.addEventListener('submit', function(e) {
        // Ki·ªÉm tra ReCAPTCHA
        if (window.grecaptcha) {
          const response = grecaptcha.getResponse();
          if (!response) {
            // Th·ª≠ fallback CAPTCHA
            const fallbackInput = document.getElementById('captchaInput');
            if (fallbackInput && fallbackInput.style.display !== 'none') {
              const captchaCode = document.getElementById('captchaCode').innerText;
              if (fallbackInput.value !== captchaCode) {
                e.preventDefault();
                alert('M√£ x√°c th·ª±c kh√¥ng ƒë√∫ng!');
                return false;
              }
            } else {
              e.preventDefault();
              alert('Vui l√≤ng ho√†n th√†nh x√°c th·ª±c CAPTCHA');
              return false;
            }
          }
          if (response) {
            document.getElementById('g-recaptcha-response').value = response;
          }
        }
      });
    }

    // Fallback CAPTCHA n·∫øu ReCAPTCHA kh√¥ng load
    function initializeFallbackCaptcha() {
      setTimeout(function() {
        const recaptchaContainer = document.getElementById('recaptchaContainer');
        const fallbackCaptcha = document.getElementById('fallbackCaptcha');
        
        // N·∫øu ReCAPTCHA kh√¥ng render (kh√¥ng c√≥ iframe), d√πng fallback
        if (recaptchaContainer && !recaptchaContainer.querySelector('iframe')) {
          recaptchaContainer.style.display = 'none';
          fallbackCaptcha.style.display = 'block';
          
          // T·∫°o m√£ CAPTCHA random (2 ch·ªØ s·ªë)
          const captchaCode = String(Math.floor(Math.random() * 100)).padStart(2, '0');
          document.getElementById('captchaCode').innerText = captchaCode;
          
          // L∆∞u v√†o hidden field
          const hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = 'captcha_answer';
          hiddenInput.value = captchaCode;
          document.getElementById('loginForm').appendChild(hiddenInput);
        }
      }, 2000); // Ch·ªù 2 gi√¢y ƒë·ªÉ ReCAPTCHA load
    }
  </script>
</body>
</html>
